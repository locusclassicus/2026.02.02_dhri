library(ellmer)
library(pdftools)
library(tidyverse)

# На месте трех точек должен быть ваш ключ
Sys.setenv(OPENAI_API_KEY = "...")

# Загружаем PDF-файлы глав; на месте dir дожно быть имя папки в рабочей директории
pdf_paths <- list.files("./dir", pattern = "pdf", full.names = TRUE)
pdf_paths <- as.list(pdf_paths)

# Извлекаем текст из всех PDF (при условии, что они распознаны)
pdf_texts <- purrr::map(pdf_paths, pdf_text)

# Имена файлов для удобства отсылок
chapter_names <- basename(unlist(pdf_paths))
chapter_names <- str_remove(chapter_names, "\\.pdf$")

# ПРОМПТ 1: Анализ отдельных глав 
# Для написания промта тоже задействуются LLM


system_analyzer <- "Ты — опытный научный рецензент, анализирующий главы коллективной монографии (выходные данные).
Твоя задача — проанализировать предоставленную главу (на английском языке) и предоставить краткий анализ на русском языке по следующей структуре:
1. **Основная тема и тезис**: В чем главная идея главы?
2. **Ключевые аргументы/методы**: Какие доказательства или методы использует автор?
3. **Сильные стороны**: Что удалось автору особенно хорошо?
4. **Слабые стороны / вопросы**: Что вызывает сомнения или требует доработки?
5. **Связь с общей темой монографии**: Как эта глава связана с предполагаемой общей темой книги?
Анализ должен быть объективным, содержательным, но лаконичным (примерно 150-200 слов)."

# Цикл для анализа глав

analyze_chapter <- function(chapter_text, chapter_name) {
  cat("Анализирую главу:", chapter_name, "\n")

  chat_analyzer <- chat_openai(system_prompt = system_analyzer,
                               model = "gpt-5.1")

  user_prompt <- paste("Пожалуйста, проанализируй следующую главу научной монографии:\n\n",
                       "НАЗВАНИЕ ГЛАВЫ: ", chapter_name, "\n\n",
                       "СОДЕРЖАНИЕ ГЛАВЫ:\n",
                       paste(chapter_text, collapse = "\n"),
                       "\n\n---\nПредоставь анализ на русском языке по указанной структуре.")

  response <- chat_analyzer$chat(user_prompt)

  # Пауза, чтобы не перегружать сервер (длительность уточняйте)
  Sys.sleep(1)

  return(list(
    chapter_name = chapter_name,
    analysis = response
  ))
}

# Применяем функцию ко всем главам
chapter_analyses <- purrr::map2(pdf_texts, chapter_names,
                                ~ analyze_chapter(.x, .y),
                                .progress = TRUE)

# Сохраняем анализы глав во внешний файл (на будущее)
saveRDS(chapter_analyses, file = "chapter_analyses.rds")

### ПРОМПТ 2: Синтез рецензии на всю монографию 
### Чем подробнее инструкция, тем лучше будет результат


system_reviewer <- "Ты — ведущий эксперт в данной научной области, пишущий рецензию на коллективную монографию.
Ты получил подробные анализы каждой главы от ассистента. На их основе составь целостную рецензию на русском языке.
Рецензия должна быть структурированной, критической, но конструктивной, предназначенной для публикации в научном журнале."

chat_reviewer <- chat_openai(system_prompt = system_reviewer,
                             model = "gpt-5.1")

# Подготавливаем материал для финального промпта
analyses_text <- ""
for (item in chapter_analyses) {
  analyses_text <- paste0(analyses_text,
                          "\n\n--- ГЛАВА: ", item$chapter_name, " ---\n",
                          item$analysis)
}

final_prompt <- paste("На основании подробных анализов отдельных глав, предоставленных ниже, напиши рецензию на коллективную монографию на русском языке.

Рецензия должна включать следующие разделы:
1. **Введение**: Предмет монографии, ее цели и заявленная актуальность.
2. **Структура и содержание**: Обзор логики построения книги, освещаемых тем.
3. **Сводный анализ сильных сторон монографии**: Что удалось редакторам и авторам в целом? Есть ли сквозные идеи, удачные методологии, новаторские подходы?
4. **Критические замечания и упущения**: Какие пробелы, противоречия или слабые места наблюдаются в книге в целом? Возможно, дисбаланс в освещении тем, недостаточная проработка некоторых аспектов.
5. **Выводы и значение**: Кому будет полезна эта монография? Какой вклад она вносит в область? Можно ли рекомендовать ее к публикации/приобретению?

Анализы глав:
", analyses_text,
                      "\n\n---\nПожалуйста, напиши развернутую рецензию, ссылаясь на конкретные главы, где это уместно.")

final_response <- chat_reviewer$chat(final_prompt)

# Извлекаем и сохраняем рецензию
monograph_review <- final_response
cat(monograph_review, file = "рецензия_на_монографию.txt")

# Выводим часть рецензии в консоль
cat(substr(monograph_review, 1, 1000), "...\n")
